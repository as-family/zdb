name: CMake on a single platform

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Debug

jobs:
  build:
    # The CMake configure and build commands are platform agnostic and should work equally well on Windows or Mac.
    # You can convert this to a matrix build if you need cross-platform coverage.
    # See: https://docs.github.com/en/free-pro-team@latest/actions/learn-github-actions/managing-complex-workflows#using-a-build-matrix
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Cache vcpkg
      uses: actions/cache@v4
      with:
        path: |
          vcpkg
          !vcpkg/buildtrees
          !vcpkg/downloads
        key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-${{ runner.os }}-

    - name: Cache vcpkg downloads
      uses: actions/cache@v4
      with:
        path: vcpkg/downloads
        key: vcpkg-downloads-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-downloads-${{ runner.os }}-

    - name: Cache apt packages
      uses: actions/cache@v4
      with:
        path: /var/cache/apt
        key: apt-packages-${{ runner.os }}
        restore-keys: |
          apt-packages-${{ runner.os }}

    - name: Install dependencies and static analysis tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cppcheck \
          clang-tidy \
          clang-tools

    - name: Setup vcpkg
      run: |
        chmod +x setup-vcpkg.sh
        ./setup-vcpkg.sh

    - name: Cache CMake build
      uses: actions/cache@v4
      with:
        path: out/build/gcc-14
        key: cmake-build-${{ runner.os }}-gcc-14-${{ hashFiles('**/CMakeLists.txt', 'src/**/*.cpp', 'src/**/*.hpp', 'tst/**/*.cpp', 'vcpkg.json', 'CMakePresets.json') }}
        restore-keys: |
          cmake-build-${{ runner.os }}-gcc-14-

    - name: Configure CMake using preset
      # Use the gcc-14-config preset from CMakePresets.json
      run: cmake --preset gcc-14-config

    - name: Get build directory from CMake
      id: build-dir
      run: |
        BUILD_DIR=$(cmake -L --preset gcc-14-config | grep ZDB_BUILD_DIR | cut -d= -f2)
        if [ -z "$BUILD_DIR" ]; then
          BUILD_DIR="${{github.workspace}}/out/build/gcc-14"
        fi
        echo "build_dir=$BUILD_DIR" >> $GITHUB_OUTPUT
        echo "Build directory: $BUILD_DIR"

    - name: Build using preset
      # Build using the gcc-14-build preset
      run: cmake --build --preset gcc-14-build

    - name: Run cppcheck
      run: |
        cppcheck --enable=all --std=c++23 --suppress=missingIncludeSystem \
          --xml --xml-version=2 src/ 2> cppcheck-report.xml

    - name: Cache clang-tidy analysis
      uses: actions/cache@v4
      with:
        path: .clang-tidy-cache
        key: clang-tidy-${{ runner.os }}-${{ hashFiles('src/**/*.cpp', 'src/**/*.hpp', '.clang-tidy') }}
        restore-keys: |
          clang-tidy-${{ runner.os }}-

    - name: Run clang-tidy
      run: |
        # Create cache directory for clang-tidy
        mkdir -p .clang-tidy-cache
        
        # Method 1: Direct clang-tidy with compile_commands.json (most reliable)
        # Only analyze .cpp files directly; .hpp files are analyzed via HeaderFilterRegex when included
        find src/ -name "*.cpp" | xargs -I {} clang-tidy {} -p ${{ steps.build-dir.outputs.build_dir }} --format-style=file --quiet
        
        # Method 2: Alternative using CMake target (uncomment to use)
        # cmake --build ${{ steps.build-dir.outputs.build_dir }} --target clang-tidy
        
        # Method 3: Using run-clang-tidy for parallel execution (fastest for large codebases)
        # if command -v run-clang-tidy >/dev/null 2>&1; then
        #   run-clang-tidy -p ${{ steps.build-dir.outputs.build_dir }} -quiet src/ -j $(nproc)
        # fi

    - name: Test
      working-directory: ${{ steps.build-dir.outputs.build_dir }}
      # Execute tests defined by the CMake configuration using ctest
      run: ctest --output-on-failure

    - name: Install
      # Install the built binaries
      run: cmake --install ${{ steps.build-dir.outputs.build_dir }} --prefix ${{github.workspace}}/install

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: zdb-${{env.BUILD_TYPE}}-${{runner.os}}
        path: |
          ${{github.workspace}}/install/
          cppcheck-report.xml
        retention-days: 30

  release:
    needs: [build]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
    - name: Download GCC artifacts
      uses: actions/download-artifact@v4
      with:
        name: zdb-${{env.BUILD_TYPE}}-${{runner.os}}
        path: ./artifacts-gcc

    - name: Create Release Archive
      run: |
        mkdir -p release
        cp -r artifacts-gcc/install/* release/ 2>/dev/null || true
        cp artifacts-gcc/zdb release/zdb 2>/dev/null || true
        tar -czf zdb-release.tar.gz -C release .

    - name: Upload Release Archive
      uses: actions/upload-artifact@v4
      with:
        name: zdb-release-package
        path: zdb-release.tar.gz
        retention-days: 90
